<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Echo-Sight | Sighted Ally View</title>
  <style>
    :root {
      --bg: #020406;
      --panel: #071117;
      --panel-soft: #0b1a22;
      --neon: #00ffd1;
      --neon-soft: #92ffea;
      --text: #ddfff8;
      --muted: #89d8c9;
      --danger: #ffb19f;
      --warn: #ffdca8;
      --safe: #8dffd2;
      --border: #2fb8a0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: radial-gradient(circle at 15% 10%, #0b1b24 0%, var(--bg) 45%, #010203 100%);
      color: var(--text);
      font-family: "JetBrains Mono", "Fira Code", ui-monospace, monospace;
      min-height: 100vh;
      overflow: hidden;
    }

    .frame {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .topbar {
      border-bottom: 1px solid var(--border);
      background: rgba(3, 11, 15, 0.85);
      padding: 0.85rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(4px);
    }

    .title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.95rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--neon-soft);
      text-shadow: 0 0 14px rgba(0, 255, 209, 0.25);
    }

    .dot {
      width: 0.65rem;
      height: 0.65rem;
      border-radius: 999px;
      background: #ff8774;
      box-shadow: 0 0 10px rgba(255, 135, 116, 0.9);
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .dot.connected {
      background: var(--safe);
      box-shadow: 0 0 10px rgba(141, 255, 210, 0.9);
    }

    .status {
      color: var(--muted);
      font-size: 0.85rem;
      letter-spacing: 0.04em;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 360px;
      gap: 1rem;
      padding: 1rem;
      height: calc(100vh - 56px);
    }

    .video-panel {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #050a0d;
      box-shadow: 0 0 0 1px rgba(0, 255, 209, 0.15), inset 0 0 40px rgba(0, 255, 209, 0.06);
    }

    .video-panel img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .hud {
      display: grid;
      gap: 0.8rem;
      overflow: auto;
      padding-right: 0.3rem;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-soft) 100%);
      padding: 0.9rem;
    }

    .card h2 {
      color: var(--neon-soft);
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      margin-bottom: 0.65rem;
    }

    .voice {
      min-height: 2.5rem;
      color: var(--text);
      font-size: 1.1rem;
      line-height: 1.35;
      text-shadow: 0 0 12px rgba(0, 255, 209, 0.2);
    }

    .haptic-value {
      font-size: 2rem;
      color: var(--neon-soft);
      margin-bottom: 0.45rem;
    }

    .bar-shell {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #051017;
      height: 1.15rem;
      overflow: hidden;
    }

    .bar-fill {
      width: 0%;
      height: 100%;
      background: var(--safe);
      box-shadow: 0 0 14px rgba(141, 255, 210, 0.35);
      transition: width 0.2s ease, background 0.2s ease;
    }

    .det-list {
      list-style: none;
      display: grid;
      gap: 0.35rem;
      max-height: 220px;
      overflow: auto;
      color: var(--text);
      font-size: 0.82rem;
    }

    .det-item {
      border: 1px solid rgba(141, 255, 210, 0.22);
      border-radius: 7px;
      padding: 0.45rem 0.55rem;
      background: rgba(7, 24, 31, 0.85);
    }

    .log {
      max-height: 210px;
      overflow: auto;
      display: grid;
      gap: 0.35rem;
      font-size: 0.77rem;
      color: var(--muted);
    }

    .log-line {
      border-bottom: 1px solid rgba(141, 255, 210, 0.18);
      padding-bottom: 0.32rem;
    }

    @media (max-width: 980px) {
      body {
        overflow: auto;
      }

      .layout {
        grid-template-columns: 1fr;
        height: auto;
        min-height: calc(100vh - 56px);
      }

      .video-panel {
        min-height: 52vh;
      }
    }
  </style>
</head>
<body>
  <div class="frame">
    <header class="topbar">
      <div class="title">
        <div id="ws-dot" class="dot"></div>
        <div>Echo-Sight / Sighted Ally View</div>
      </div>
      <div id="ws-status" class="status">WebSocket disconnected</div>
    </header>

    <main class="layout">
      <section class="video-panel">
        <img id="stream" src="/video_feed" alt="ESP32-CAM feed" />
        <canvas id="overlay"></canvas>
      </section>

      <aside class="hud">
        <article class="card">
          <h2>Voice Prompt</h2>
          <div id="voice" class="voice">Waiting for inference...</div>
        </article>

        <article class="card">
          <h2>Haptic Intensity (0-255)</h2>
          <div id="haptic-value" class="haptic-value">0</div>
          <div class="bar-shell">
            <div id="haptic-fill" class="bar-fill"></div>
          </div>
        </article>

        <article class="card">
          <h2>Detections</h2>
          <ul id="det-list" class="det-list">
            <li class="det-item">No detections yet</li>
          </ul>
        </article>

        <article class="card">
          <h2>Event Log</h2>
          <div id="log" class="log"></div>
        </article>
      </aside>
    </main>
  </div>

  <audio id="tts-audio" autoplay></audio>

  <script>
    const wsDot = document.getElementById("ws-dot");
    const wsStatus = document.getElementById("ws-status");
    const voiceEl = document.getElementById("voice");
    const hapticValueEl = document.getElementById("haptic-value");
    const hapticFillEl = document.getElementById("haptic-fill");
    const detListEl = document.getElementById("det-list");
    const logEl = document.getElementById("log");
    const streamEl = document.getElementById("stream");
    const overlayEl = document.getElementById("overlay");
    const audioEl = document.getElementById("tts-audio");
    const ctx = overlayEl.getContext("2d");

    let lastDetections = [];
    let audioToken = 0;

    function appendLog(message) {
      const line = document.createElement("div");
      line.className = "log-line";
      const stamp = new Date().toLocaleTimeString();
      line.textContent = `[${stamp}] ${message}`;
      logEl.prepend(line);

      while (logEl.childElementCount > 45) {
        logEl.removeChild(logEl.lastChild);
      }
    }

    function resizeOverlay() {
      const rect = streamEl.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      overlayEl.width = Math.max(1, Math.floor(rect.width * dpr));
      overlayEl.height = Math.max(1, Math.floor(rect.height * dpr));
      overlayEl.style.width = `${rect.width}px`;
      overlayEl.style.height = `${rect.height}px`;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      drawDetections(lastDetections);
    }

    function updateHaptic(value) {
      const v = Math.max(0, Math.min(255, Number(value) || 0));
      const pct = (v / 255) * 100;
      hapticValueEl.textContent = String(v);
      hapticFillEl.style.width = `${pct}%`;

      if (v >= 180) {
        hapticFillEl.style.background = "var(--danger)";
      } else if (v >= 90) {
        hapticFillEl.style.background = "var(--warn)";
      } else {
        hapticFillEl.style.background = "var(--safe)";
      }
    }

    function updateDetectionsList(detections) {
      detListEl.innerHTML = "";
      if (!detections.length) {
        const li = document.createElement("li");
        li.className = "det-item";
        li.textContent = "No active obstacles";
        detListEl.appendChild(li);
        return;
      }

      detections.forEach((det) => {
        const box = det.box || [];
        const li = document.createElement("li");
        li.className = "det-item";
        li.textContent = `${det.label || "obstacle"} :: [${box.join(", ")}]`;
        detListEl.appendChild(li);
      });
    }

    function drawDetections(detections) {
      const width = overlayEl.clientWidth;
      const height = overlayEl.clientHeight;
      ctx.clearRect(0, 0, width, height);

      detections.forEach((det) => {
        if (!Array.isArray(det.box) || det.box.length !== 4) {
          return;
        }
        const [ymin, xmin, ymax, xmax] = det.box;
        const x = (xmin / 1000) * width;
        const y = (ymin / 1000) * height;
        const w = ((xmax - xmin) / 1000) * width;
        const h = ((ymax - ymin) / 1000) * height;

        ctx.strokeStyle = "#00ffd1";
        ctx.lineWidth = 2.2;
        ctx.shadowColor = "rgba(0, 255, 209, 0.85)";
        ctx.shadowBlur = 12;
        ctx.strokeRect(x, y, w, h);
        ctx.shadowBlur = 0;

        const label = det.label || "obstacle";
        const tag = `${label}`;
        ctx.font = "600 12px JetBrains Mono";
        const textWidth = ctx.measureText(tag).width + 14;
        const labelY = Math.max(18, y - 8);
        ctx.fillStyle = "rgba(0, 20, 17, 0.92)";
        ctx.fillRect(x, labelY - 14, textWidth, 18);
        ctx.strokeStyle = "#00ffd1";
        ctx.strokeRect(x, labelY - 14, textWidth, 18);
        ctx.fillStyle = "#dcfff8";
        ctx.fillText(tag, x + 7, labelY);
      });
    }

    async function tryPlayLatestAudio() {
      const token = ++audioToken;
      try {
        const res = await fetch("/audio/latest", { cache: "no-store" });
        if (token !== audioToken || !res.ok || res.status === 204) {
          return;
        }
        const blob = await res.blob();
        if (!blob.size) {
          return;
        }
        const url = URL.createObjectURL(blob);
        audioEl.src = url;
        await audioEl.play().catch(() => {});
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      } catch (_err) {
      }
    }

    function applyMessage(data) {
      const voicePrompt = typeof data.voice_prompt === "string" ? data.voice_prompt : "Path is clear";
      const detections = Array.isArray(data.detections) ? data.detections : [];
      const intensity = Number(data.haptic_intensity || 0);

      voiceEl.textContent = voicePrompt;
      lastDetections = detections;
      updateHaptic(intensity);
      updateDetectionsList(detections);
      drawDetections(detections);

      appendLog(`${voicePrompt} | haptic=${Math.max(0, Math.min(255, intensity))}`);
      if (voicePrompt && voicePrompt !== "Path is clear") {
        tryPlayLatestAudio();
      }
    }

    function connect() {
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${protocol}://${window.location.host}/ws`);

      ws.onopen = () => {
        wsDot.classList.add("connected");
        wsStatus.textContent = "WebSocket connected";
        appendLog("WebSocket connected");
      };

      ws.onclose = () => {
        wsDot.classList.remove("connected");
        wsStatus.textContent = "WebSocket disconnected";
        appendLog("WebSocket disconnected. Retrying in 1.5s");
        setTimeout(connect, 1500);
      };

      ws.onerror = () => ws.close();

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (typeof data === "object" && data !== null) {
            applyMessage(data);
          }
        } catch (_err) {
          appendLog("Received non-JSON payload");
        }
      };
    }

    streamEl.addEventListener("load", resizeOverlay);
    window.addEventListener("resize", resizeOverlay);
    setInterval(resizeOverlay, 700);
    resizeOverlay();
    connect();
  </script>
</body>
</html>
